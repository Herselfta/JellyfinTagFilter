<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Jellyfin ç­›é€‰">
    <meta name="theme-color" content="#000000">
    <title>Jellyfin æ ‡ç­¾ç­›é€‰å™¨</title>
    <link rel="manifest" href="/web/tag_filter_manifest.json">
    <style>
        :root {
            /* Jellyfin ä¸»é¢˜è‰² */
            --primary-color: #00a4dc;
            --bg-color: #101010;
            --card-bg: #181818;
            --text-primary: #ffffff;
            --text-secondary: #999999;
            --border-color: #303030;
            --hover-bg: #252525;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  - Jellyfin é£æ ¼ */
        .header {
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo {
            width: 28px;
            height: 28px;
            background: var(--primary-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: background 0.2s;
        }

        .icon-btn:active {
            background: var(--hover-bg);
        }

        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
        }

        .section {
            padding: 16px;
        }

        /* é…ç½®é¢æ¿ - å¯æŠ˜å  */
        .config-panel {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .config-panel.collapsed {
            max-height: 0 !important;
        }

        .config-content {
            padding: 16px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 16px;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
        }

        .btn:active {
            opacity: 0.8;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* æ ‡ç­¾ç­›é€‰åŒº */
        .filter-section {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .clear-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 14px;
            padding: 4px 8px;
            cursor: pointer;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 12px;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 2px;
        }

        .tag {
            padding: 6px 14px;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tag:active {
            transform: scale(0.95);
        }

        .tag.selected {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .tag-count {
            opacity: 0.6;
            font-size: 11px;
            margin-left: 4px;
        }

        /* ç»“æœåŒºåŸŸ */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .result-count {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .view-toggle {
            display: flex;
            gap: 4px;
            background: var(--hover-bg);
            border-radius: 4px;
            padding: 2px;
        }

        .view-toggle button {
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            border-radius: 3px;
            cursor: pointer;
        }

        .view-toggle button.active {
            background: var(--primary-color);
            color: white;
        }

        /* ç½‘æ ¼è§†å›¾ */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 12px;
        }

        .media-item {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .media-item:active {
            transform: scale(0.95);
        }

        .media-poster {
            width: 100%;
            aspect-ratio: 2/3;
            background: var(--hover-bg);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .media-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-poster-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            background: linear-gradient(135deg, #1e1e1e, #2a2a2a);
        }

        .media-title {
            font-size: 13px;
            margin-top: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3;
        }

        /* åˆ—è¡¨è§†å›¾ */
        .media-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .media-list .media-item {
            display: flex;
            gap: 12px;
            background: var(--card-bg);
            border-radius: 6px;
            padding: 12px;
            border: 1px solid var(--border-color);
        }

        .media-list .media-poster {
            width: 80px;
            height: 120px;
            flex-shrink: 0;
        }

        .media-list .media-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .media-list .media-title {
            font-size: 15px;
            margin-bottom: 6px;
        }

        .media-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .media-tag {
            padding: 2px 8px;
            background: var(--hover-bg);
            border-radius: 10px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* æ¶ˆæ¯æç¤º */
        .message {
            padding: 12px 16px;
            margin: 16px;
            border-radius: 6px;
            font-size: 14px;
        }

        .message.error {
            background: #3a1a1a;
            color: #ff6b6b;
            border: 1px solid #6b2020;
        }

        .message.success {
            background: #1a3a2a;
            color: #51cf66;
            border: 1px solid #206b30;
        }

        .message.loading {
            background: var(--card-bg);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }

        /* è¯¦æƒ…é¡µè¦†ç›–å±‚ */
        .detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .detail-overlay.show {
            transform: translateX(0);
        }

        .detail-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }

        .detail-back {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 12px;
        }

        .detail-back:active {
            background: var(--hover-bg);
        }

        .detail-title {
            font-size: 16px;
            font-weight: 600;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .rotate-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-left: 8px;
        }

        .rotate-btn:active {
            background: var(--hover-bg);
        }

        .rotate-btn.active {
            color: var(--primary-color);
        }

        .detail-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Jellyfin æ’­æ”¾å™¨ iframe */
        .jellyfin-player {
            width: 100%;
            flex: 1;
            border: none;
            background: #000;
        }

        /* å…¨å±æ—¶è‡ªåŠ¨è°ƒæ•´ */
        .detail-overlay:fullscreen,
        .detail-overlay:-webkit-full-screen,
        .detail-overlay:-moz-full-screen {
            width: 100vw;
            height: 100vh;
        }

        .detail-overlay:fullscreen .detail-header,
        .detail-overlay:-webkit-full-screen .detail-header,
        .detail-overlay:-moz-full-screen .detail-header {
            display: none;
        }

        .detail-overlay:fullscreen .detail-content,
        .detail-overlay:-webkit-full-screen .detail-content,
        .detail-overlay:-moz-full-screen .detail-content {
            flex: 1;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--hover-bg);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #404040;
        }

        @media (min-width: 768px) {
            .media-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header">
        <div class="header-title">
            <div class="logo">ğŸ¬</div>
            <span>æ ‡ç­¾ç­›é€‰</span>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="toggleConfig()" title="è®¾ç½®">âš™ï¸</button>
            <button class="icon-btn" onclick="refreshData()" title="åˆ·æ–°">ğŸ”„</button>
        </div>
    </div>

    <!-- é…ç½®é¢æ¿ -->
    <div class="config-panel collapsed" id="configPanel">
        <div class="config-content">
            <div class="input-group">
                <label>æœåŠ¡å™¨åœ°å€</label>
                <input type="text" id="serverUrl" placeholder="http://localhost:8096">
            </div>
            <div class="input-group">
                <label>API å¯†é’¥</label>
                <input type="password" id="apiKey" placeholder="æ‚¨çš„ API Key">
            </div>
            <div class="input-group">
                <label>åª’ä½“åº“ ID</label>
                <input type="text" id="libraryId" placeholder="åª’ä½“åº“ ID">
            </div>
            <button class="btn" onclick="loadData()">åŠ è½½åª’ä½“åº“</button>
            
            <!-- é…ç½®ç®¡ç†æŒ‰é’® -->
            <div style="display: flex; gap: 8px; margin-top: 12px;">
                <button class="btn" style="background: #2d2d2d; flex: 1;" onclick="exportConfig()">ğŸ“‹ åˆ†äº«é“¾æ¥</button>
                <button class="btn" style="background: #2d2d2d; flex: 1;" onclick="exportConfigFile()">ğŸ’¾ å¯¼å‡º</button>
                <button class="btn" style="background: #2d2d2d; flex: 1;" onclick="importConfigFile()">ğŸ“‚ å¯¼å…¥</button>
            </div>
            
            <div style="margin-top: 16px; padding: 12px; background: rgba(0, 164, 220, 0.1); border-radius: 4px; font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                ğŸ’¡ <strong>æŒä¹…åŒ–æç¤ºï¼š</strong><br>
                â€¢ <strong>åˆ†äº«é“¾æ¥</strong>ï¼šç”Ÿæˆå¸¦é…ç½®çš„URLï¼Œä¿å­˜åç›´æ¥è®¿é—®<br>
                â€¢ <strong>å¯¼å‡º/å¯¼å…¥</strong>ï¼šä¿å­˜é…ç½®æ–‡ä»¶åˆ°æœ¬åœ°ï¼Œå¯åœ¨å…¶ä»–è®¾å¤‡ä½¿ç”¨<br>
                â€¢ <strong>æ·»åŠ åˆ°ä¸»å±å¹•</strong>ï¼šåƒåŸç”Ÿåº”ç”¨ä¸€æ ·ä½¿ç”¨ï¼Œæ— éœ€é‡å¤é…ç½®
            </div>
        </div>
    </div>

    <div id="message"></div>

    <div class="container">
        <!-- æ ‡ç­¾ç­›é€‰ -->
        <div class="filter-section section hidden" id="filterSection">
            <div class="section-header">
                <div class="section-title">é€‰æ‹©æ ‡ç­¾ï¼ˆAND é€»è¾‘ï¼‰</div>
                <button class="clear-btn" onclick="clearSelection()">æ¸…é™¤</button>
            </div>
            <input type="text" class="search-input" id="tagSearch" placeholder="ğŸ” æœç´¢æ ‡ç­¾..." oninput="filterTags()">
            <div class="tags-container" id="tagsContainer"></div>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div class="section hidden" id="resultsSection">
            <div class="results-header">
                <div class="result-count" id="resultCount">0 ä¸ªç»“æœ</div>
                <div class="view-toggle">
                    <button class="active" onclick="setView('grid')">ç½‘æ ¼</button>
                    <button onclick="setView('list')">åˆ—è¡¨</button>
                </div>
            </div>
            <div class="media-grid" id="resultsContainer"></div>
        </div>
    </div>

    <!-- è¯¦æƒ…é¡µè¦†ç›–å±‚ -->
    <div class="detail-overlay" id="detailOverlay">
        <div class="detail-header">
            <button class="detail-back" onclick="closeDetail()">â†</button>
            <div class="detail-title" id="detailTitle">æ­£åœ¨æ’­æ”¾</div>
            <button class="rotate-btn" id="rotateBtn" onclick="toggleRotation()" title="æ¨ªç«–å±åˆ‡æ¢">ğŸ”„</button>
        </div>
        <div class="detail-content">
            <!-- ä½¿ç”¨ Jellyfin å†…ç½®æ’­æ”¾å™¨ -->
            <iframe class="jellyfin-player" id="jellyfinPlayer" allowfullscreen></iframe>
        </div>
    </div>

    <script>
        let allItems = [];
        let allTags = new Map();
        let selectedTags = new Set();
        let currentView = 'grid';
        let serverUrl = '';
        let apiKey = '';
        let libraryId = '';
        let currentOrientation = 'auto'; // 'auto', 'landscape', 'portrait'

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            // åŠ¨æ€æ›´æ–° manifest çš„ start_url ä¸ºå½“å‰å®Œæ•´URL
            updateManifestUrl();
            
            loadConfigFromURL(); // å…ˆå°è¯•ä»URLåŠ è½½
            loadConfig(); // å†ä»localStorageåŠ è½½
            
            // å¦‚æœå·²æœ‰é…ç½®ï¼Œè‡ªåŠ¨åŠ è½½
            if (serverUrl && apiKey && libraryId) {
                loadData();
                showInstallPrompt(); // æ˜¾ç¤ºPWAå®‰è£…æç¤º
            } else {
                document.getElementById('configPanel').classList.remove('collapsed');
            }
        });

        // åŠ¨æ€æ›´æ–° manifest çš„ start_url
        function updateManifestUrl() {
            // è·å–å½“å‰é¡µé¢çš„å®Œæ•´ URL
            const currentUrl = window.location.href.split('?')[0]; // å»æ‰å‚æ•°
            
            // åˆ›å»ºæ–°çš„ manifest å¯¹è±¡
            const manifest = {
                "name": "Jellyfin æ ‡ç­¾ç­›é€‰å™¨",
                "short_name": "æ ‡ç­¾ç­›é€‰",
                "description": "Jellyfin AND é€»è¾‘æ ‡ç­¾ç­›é€‰å·¥å…·",
                "start_url": currentUrl,
                "scope": currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1),
                "display": "standalone",
                "background_color": "#101010",
                "theme_color": "#000000",
                "orientation": "portrait-primary",
                "icons": [
                    {
                        "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%2300a4dc' width='100' height='100' rx='20'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white'%3EğŸ¬%3C/text%3E%3C/svg%3E",
                        "sizes": "512x512",
                        "type": "image/svg+xml",
                        "purpose": "any maskable"
                    }
                ],
                "categories": ["entertainment", "utilities"],
                "lang": "zh-CN"
            };
            
            // åˆ›å»º Blob URL
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            
            // æ›´æ–° manifest é“¾æ¥
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                manifestLink.href = manifestUrl;
            }
        }

        // ä»URLå‚æ•°åŠ è½½é…ç½®
        function loadConfigFromURL() {
            const params = new URLSearchParams(window.location.search);
            const urlServer = params.get('server');
            const urlApiKey = params.get('key');
            const urlLibraryId = params.get('library');
            
            // å¦‚æœURLä¸­æœ‰é…ç½®ï¼Œè‡ªåŠ¨ä¿å­˜åˆ°localStorage
            if (urlServer) {
                serverUrl = urlServer;
                localStorage.setItem('jellyfin_server', serverUrl);
            }
            if (urlApiKey) {
                apiKey = urlApiKey;
                localStorage.setItem('jellyfin_api_key', apiKey);
            }
            if (urlLibraryId) {
                libraryId = urlLibraryId;
                localStorage.setItem('jellyfin_library_id', libraryId);
            }
            
            // å¦‚æœURLä¸­æœ‰å®Œæ•´é…ç½®ï¼Œæ¸…ç†URLï¼ˆé˜²æ­¢API Keyæš´éœ²åœ¨åœ°å€æ ï¼‰
            if (urlServer || urlApiKey || urlLibraryId) {
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            }
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            // åªåœ¨æ²¡æœ‰ä»URLåŠ è½½æ—¶æ‰ä»localStorageåŠ è½½
            if (!serverUrl) serverUrl = localStorage.getItem('jellyfin_server') || '';
            if (!apiKey) apiKey = localStorage.getItem('jellyfin_api_key') || '';
            if (!libraryId) libraryId = localStorage.getItem('jellyfin_library_id') || '';
            
            if (serverUrl) document.getElementById('serverUrl').value = serverUrl;
            if (apiKey) document.getElementById('apiKey').value = apiKey;
            if (libraryId) document.getElementById('libraryId').value = libraryId;
        }

        // PWAå®‰è£…æç¤º
        let deferredPrompt;
        let installShown = localStorage.getItem('install_prompt_shown') === 'true';

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        function showInstallPrompt() {
            if (installShown) return;
            
            // æ£€æµ‹æ˜¯å¦å·²ç»æ˜¯PWAç¯å¢ƒ
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches 
                              || window.navigator.standalone 
                              || document.referrer.includes('android-app://');
            
            if (isStandalone) return;
            
            // é¦–æ¬¡ä½¿ç”¨æ—¶æ˜¾ç¤ºå®‰è£…æç¤º
            setTimeout(() => {
                if (confirm('ğŸ’¡ æç¤ºï¼šå°†æ­¤é¡µé¢æ·»åŠ åˆ°ä¸»å±å¹•ï¼Œå³å¯åƒåŸç”Ÿåº”ç”¨ä¸€æ ·ä½¿ç”¨ï¼Œæ— éœ€æ¯æ¬¡éƒ½é‡æ–°è®¿é—®ï¼\n\nç‚¹å‡»ç¡®å®šæŸ¥çœ‹æ“ä½œæŒ‡å—')) {
                    showInstallGuide();
                }
                installShown = true;
                localStorage.setItem('install_prompt_shown', 'true');
            }, 2000);
        }

        function showInstallGuide() {
            const guide = `
ğŸ“± æ·»åŠ åˆ°ä¸»å±å¹•ï¼š

iOS (Safari):
1. ç‚¹å‡»åº•éƒ¨ [åˆ†äº«] æŒ‰é’® 
2. é€‰æ‹© [æ·»åŠ åˆ°ä¸»å±å¹•]
3. ç‚¹å‡» [æ·»åŠ ]

Android (Chrome):
1. ç‚¹å‡»å³ä¸Šè§’ [â‹®] èœå•
2. é€‰æ‹© [æ·»åŠ åˆ°ä¸»å±å¹•]
3. ç‚¹å‡» [æ·»åŠ ]

æ·»åŠ åï¼Œä»ä¸»å±å¹•æ‰“å¼€å³å¯ç›´æ¥ä½¿ç”¨ï¼
            `.trim();
            
            alert(guide);
        }

        // åˆ‡æ¢é…ç½®é¢æ¿
        function toggleConfig() {
            const panel = document.getElementById('configPanel');
            if (panel.classList.contains('collapsed')) {
                panel.style.maxHeight = panel.scrollHeight + 'px';
                panel.classList.remove('collapsed');
            } else {
                panel.style.maxHeight = '0';
                setTimeout(() => panel.classList.add('collapsed'), 300);
            }
        }

        // å¯¼å‡ºé…ç½®
        function exportConfig() {
            const config = {
                server: serverUrl,
                apiKey: apiKey,
                libraryId: libraryId
            };
            
            // ç”Ÿæˆå¸¦é…ç½®çš„URL
            const baseUrl = window.location.origin + window.location.pathname;
            const configUrl = `${baseUrl}?server=${encodeURIComponent(serverUrl)}&key=${encodeURIComponent(apiKey)}&library=${encodeURIComponent(libraryId)}`;
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(configUrl).then(() => {
                showMessage('âœ… é…ç½®é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ä¿å­˜æ­¤é“¾æ¥å¯åœ¨ä»»ä½•è®¾å¤‡ä¸Šå¿«é€Ÿè®¿é—®', 'success');
                
                // åŒæ—¶æ˜¾ç¤ºé“¾æ¥
                setTimeout(() => {
                    alert(`ğŸ“‹ é…ç½®é“¾æ¥å·²å¤åˆ¶ï¼\n\n${configUrl}\n\nä¿å­˜æ­¤é“¾æ¥åˆ°ï¼š\nâ€¢ æµè§ˆå™¨ä¹¦ç­¾\nâ€¢ å¤‡å¿˜å½•\nâ€¢ å‘é€åˆ°å…¶ä»–è®¾å¤‡\n\nä¸‹æ¬¡ç›´æ¥æ‰“å¼€é“¾æ¥å³å¯è‡ªåŠ¨é…ç½®ï¼`);
                }, 500);
            }).catch(() => {
                // å¦‚æœå¤åˆ¶å¤±è´¥ï¼Œç›´æ¥æ˜¾ç¤ºé“¾æ¥
                prompt('ğŸ“‹ å¤åˆ¶æ­¤é“¾æ¥ä¿å­˜ä½¿ç”¨ï¼š', configUrl);
            });
        }

        // å¯¼å‡ºé…ç½®ä¸ºJSONæ–‡ä»¶
        function exportConfigFile() {
            const config = {
                server: serverUrl,
                apiKey: apiKey,
                libraryId: libraryId,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'jellyfin_tag_filter_config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('âœ… é…ç½®æ–‡ä»¶å·²ä¸‹è½½', 'success');
        }

        // å¯¼å…¥é…ç½®æ–‡ä»¶
        function importConfigFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const config = JSON.parse(event.target.result);
                        
                        if (config.server) {
                            serverUrl = config.server;
                            localStorage.setItem('jellyfin_server', serverUrl);
                            document.getElementById('serverUrl').value = serverUrl;
                        }
                        if (config.apiKey) {
                            apiKey = config.apiKey;
                            localStorage.setItem('jellyfin_api_key', apiKey);
                            document.getElementById('apiKey').value = apiKey;
                        }
                        if (config.libraryId) {
                            libraryId = config.libraryId;
                            localStorage.setItem('jellyfin_library_id', libraryId);
                            document.getElementById('libraryId').value = libraryId;
                        }
                        
                        showMessage('âœ… é…ç½®å·²å¯¼å…¥', 'success');
                        
                        // è‡ªåŠ¨åŠ è½½æ•°æ®
                        if (serverUrl && apiKey && libraryId) {
                            setTimeout(() => loadData(), 1000);
                        }
                    } catch (error) {
                        showMessage('âŒ é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            serverUrl = document.getElementById('serverUrl').value.trim();
            apiKey = document.getElementById('apiKey').value.trim();
            libraryId = document.getElementById('libraryId').value.trim();

            if (!serverUrl || !apiKey || !libraryId) {
                showMessage('è¯·å¡«å†™å®Œæ•´é…ç½®', 'error');
                return;
            }

            localStorage.setItem('jellyfin_server', serverUrl);
            localStorage.setItem('jellyfin_api_key', apiKey);
            localStorage.setItem('jellyfin_library_id', libraryId);

            try {
                showMessage('æ­£åœ¨åŠ è½½...', 'loading');

                const url = `${serverUrl}/Items?ParentId=${libraryId}&Recursive=true&Fields=Tags&IncludeItemTypes=Movie,Episode,Video&api_key=${apiKey}`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                allItems = data.Items || [];

                // ç»Ÿè®¡æ ‡ç­¾
                allTags.clear();
                allItems.forEach(item => {
                    if (item.Tags && Array.isArray(item.Tags)) {
                        item.Tags.forEach(tag => {
                            allTags.set(tag, (allTags.get(tag) || 0) + 1);
                        });
                    }
                });

                showMessage(`âœ… åŠ è½½æˆåŠŸï¼š${allItems.length} ä¸ªé¡¹ç›®ï¼Œ${allTags.size} ä¸ªæ ‡ç­¾`, 'success');
                
                // æ”¶èµ·é…ç½®é¢æ¿
                const panel = document.getElementById('configPanel');
                panel.style.maxHeight = '0';
                setTimeout(() => panel.classList.add('collapsed'), 300);

                // æ˜¾ç¤ºç­›é€‰å’Œç»“æœ
                document.getElementById('filterSection').classList.remove('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');

                renderTags();
                filterResults();

            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                showMessage(`âŒ ${error.message}`, 'error');
            }
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            if (serverUrl && apiKey && libraryId) {
                loadData();
            }
        }

        // æ¸²æŸ“æ ‡ç­¾
        function renderTags() {
            const container = document.getElementById('tagsContainer');
            container.innerHTML = '';

            const sortedTags = Array.from(allTags.entries())
                .sort((a, b) => b[1] - a[1]);

            sortedTags.forEach(([tag, count]) => {
                const tagEl = document.createElement('div');
                tagEl.className = 'tag';
                if (selectedTags.has(tag)) {
                    tagEl.classList.add('selected');
                }
                tagEl.innerHTML = `${tag}<span class="tag-count">${count}</span>`;
                tagEl.dataset.tag = tag.toLowerCase();
                tagEl.onclick = () => toggleTag(tag);
                container.appendChild(tagEl);
            });
        }

        // ç­›é€‰æ ‡ç­¾æ˜¾ç¤º
        function filterTags() {
            const search = document.getElementById('tagSearch').value.toLowerCase();
            const tags = document.querySelectorAll('.tag');
            tags.forEach(tag => {
                const match = tag.dataset.tag.includes(search);
                tag.style.display = match ? '' : 'none';
            });
        }

        // åˆ‡æ¢æ ‡ç­¾é€‰æ‹©
        function toggleTag(tag) {
            if (selectedTags.has(tag)) {
                selectedTags.delete(tag);
            } else {
                selectedTags.add(tag);
            }
            renderTags();
            filterResults();
        }

        // æ¸…é™¤é€‰æ‹©
        function clearSelection() {
            selectedTags.clear();
            renderTags();
            filterResults();
        }

        // ç­›é€‰ç»“æœ
        function filterResults() {
            let filteredItems = allItems;

            if (selectedTags.size > 0) {
                filteredItems = allItems.filter(item => {
                    if (!item.Tags || !Array.isArray(item.Tags)) return false;
                    const itemTags = new Set(item.Tags);
                    return Array.from(selectedTags).every(tag => itemTags.has(tag));
                });
            }

            const countText = selectedTags.size > 0 
                ? `${filteredItems.length} ä¸ªç»“æœ (å·²é€‰ ${selectedTags.size} ä¸ªæ ‡ç­¾)`
                : `${filteredItems.length} ä¸ªç»“æœ`;
            document.getElementById('resultCount').textContent = countText;

            renderResults(filteredItems);
        }

        // æ¸²æŸ“ç»“æœ
        function renderResults(items) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';
            container.className = currentView === 'grid' ? 'media-grid' : 'media-list';

            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ”</div><div>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åª’ä½“</div></div>';
                return;
            }

            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'media-item';
                itemEl.onclick = () => openInJellyfin(item.Id);

                const posterUrl = item.ImageTags?.Primary 
                    ? `${serverUrl}/Items/${item.Id}/Images/Primary?api_key=${apiKey}&maxWidth=300`
                    : '';

                const tagsHtml = (item.Tags || [])
                    .map(tag => `<span class="media-tag">${tag}</span>`)
                    .join('');

                itemEl.innerHTML = `
                    <div class="media-poster">
                        ${posterUrl 
                            ? `<img src="${posterUrl}" alt="${item.Name}" loading="lazy">`
                            : `<div class="media-poster-placeholder">ğŸ¬</div>`
                        }
                    </div>
                    <div class="media-info">
                        <div class="media-title">${item.Name || 'æœªå‘½å'}</div>
                        ${tagsHtml && currentView === 'list' ? `<div class="media-tags">${tagsHtml}</div>` : ''}
                    </div>
                `;

                container.appendChild(itemEl);
            });
        }

        // åˆ‡æ¢è§†å›¾
        function setView(view) {
            currentView = view;
            const buttons = document.querySelectorAll('.view-toggle button');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            filterResults();
        }

        // åœ¨å½“å‰é¡µé¢å†…æ‰“å¼€è¯¦æƒ…ï¼ˆä½¿ç”¨ Jellyfin æ’­æ”¾å™¨ï¼‰
        function openInJellyfin(itemId) {
            const item = allItems.find(i => i.Id === itemId);
            if (!item) return;
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('detailTitle').textContent = item.Name || 'æ­£åœ¨æ’­æ”¾';
            
            // ä½¿ç”¨ Jellyfin çš„è¯¦æƒ…é¡µé¢ï¼ˆç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹æ’­æ”¾ï¼‰
            const playUrl = `${serverUrl}/web/index.html#!/details?id=${itemId}`;
            const iframe = document.getElementById('jellyfinPlayer');
            iframe.src = playUrl;
            
            // æ˜¾ç¤ºè¯¦æƒ…è¦†ç›–å±‚
            const overlay = document.getElementById('detailOverlay');
            setTimeout(() => overlay.classList.add('show'), 10);
            
            // è®¾ç½®å…¨å±è‡ªåŠ¨æ¨ªå±
            setupAutoRotation();
        }

        // è®¾ç½®è‡ªåŠ¨æ¨ªå±åŠŸèƒ½
        function setupAutoRotation() {
            // ç›‘å¬å…¨å±å˜åŒ–
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        }

        // å¤„ç†å…¨å±å˜åŒ–
        function handleFullscreenChange() {
            const rotateBtn = document.getElementById('rotateBtn');
            
            if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement) {
                // è¿›å…¥å…¨å± - æ ¹æ®å½“å‰è®¾ç½®é”å®šæ–¹å‘
                rotateBtn.style.display = 'flex'; // å…¨å±æ—¶æ˜¾ç¤ºæ—‹è½¬æŒ‰é’®
                
                if (currentOrientation !== 'auto' && screen.orientation && screen.orientation.lock) {
                    const orientation = currentOrientation === 'landscape' ? 'landscape' : 'portrait';
                    screen.orientation.lock(orientation).catch(err => {
                        console.log('æ— æ³•é”å®šå±å¹•æ–¹å‘:', err);
                    });
                }
            } else {
                // é€€å‡ºå…¨å± - è§£é”æ–¹å‘
                rotateBtn.style.display = 'flex'; // éå…¨å±ä¹Ÿæ˜¾ç¤º
                
                if (screen.orientation && screen.orientation.unlock) {
                    try {
                        screen.orientation.unlock();
                    } catch (err) {
                        console.log('æ— æ³•è§£é”å±å¹•æ–¹å‘:', err);
                    }
                }
                currentOrientation = 'auto';
                updateRotateButton();
            }
        }

        // åˆ‡æ¢æ—‹è½¬æ–¹å‘
        function toggleRotation() {
            if (!screen.orientation || !screen.orientation.lock) {
                showMessage('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå±å¹•æ–¹å‘é”å®š', 'error');
                return;
            }

            // å¾ªç¯åˆ‡æ¢ï¼šauto â†’ landscape â†’ portrait â†’ auto
            if (currentOrientation === 'auto') {
                currentOrientation = 'landscape';
            } else if (currentOrientation === 'landscape') {
                currentOrientation = 'portrait';
            } else {
                currentOrientation = 'auto';
            }

            updateRotateButton();
            applyRotation();
        }

        // æ›´æ–°æ—‹è½¬æŒ‰é’®çŠ¶æ€
        function updateRotateButton() {
            const btn = document.getElementById('rotateBtn');
            
            if (currentOrientation === 'landscape') {
                btn.textContent = 'â†”ï¸'; // æ¨ªå±
                btn.classList.add('active');
                btn.title = 'å½“å‰ï¼šæ¨ªå±ï¼ˆç‚¹å‡»åˆ‡æ¢ï¼‰';
            } else if (currentOrientation === 'portrait') {
                btn.textContent = 'â†•ï¸'; // ç«–å±
                btn.classList.add('active');
                btn.title = 'å½“å‰ï¼šç«–å±ï¼ˆç‚¹å‡»åˆ‡æ¢ï¼‰';
            } else {
                btn.textContent = 'ğŸ”„'; // è‡ªåŠ¨
                btn.classList.remove('active');
                btn.title = 'å½“å‰ï¼šè‡ªåŠ¨ï¼ˆç‚¹å‡»åˆ‡æ¢ï¼‰';
            }
        }

        // åº”ç”¨æ—‹è½¬è®¾ç½®
        function applyRotation() {
            if (!screen.orientation || !screen.orientation.lock) return;

            if (currentOrientation === 'auto') {
                // è§£é”ï¼Œæ¢å¤è‡ªåŠ¨
                screen.orientation.unlock();
                showMessage('âœ… å·²åˆ‡æ¢ä¸ºè‡ªåŠ¨æ–¹å‘', 'success');
            } else {
                // é”å®šåˆ°æŒ‡å®šæ–¹å‘
                const orientation = currentOrientation;
                screen.orientation.lock(orientation).then(() => {
                    const msg = orientation === 'landscape' ? 'âœ… å·²é”å®šæ¨ªå±' : 'âœ… å·²é”å®šç«–å±';
                    showMessage(msg, 'success');
                }).catch(err => {
                    console.log('é”å®šå¤±è´¥:', err);
                    showMessage('âš ï¸ é”å®šå¤±è´¥ï¼Œè¯·è¿›å…¥å…¨å±åå†è¯•', 'error');
                });
            }
        }

        // å…³é—­è¯¦æƒ…é¡µ
        function closeDetail() {
            // å¦‚æœåœ¨å…¨å±ï¼Œå…ˆé€€å‡ºå…¨å±
            if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement) {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                }
            }
            
            // è§£é”å±å¹•æ–¹å‘
            if (screen.orientation && screen.orientation.unlock) {
                try {
                    screen.orientation.unlock();
                } catch (err) {}
            }
            
            const overlay = document.getElementById('detailOverlay');
            overlay.classList.remove('show');
            
            // æ¸…ç©º iframe
            setTimeout(() => {
                document.getElementById('jellyfinPlayer').src = 'about:blank';
            }, 300);
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const msgEl = document.getElementById('message');
            msgEl.className = `message ${type}`;
            
            if (type === 'loading') {
                msgEl.innerHTML = `<div class="spinner"></div>${text}`;
            } else {
                msgEl.textContent = text;
            }

            if (type !== 'loading') {
                setTimeout(() => {
                    msgEl.className = '';
                    msgEl.textContent = '';
                }, 3000);
            }
        }
    </script>
</body>
</html>

